name: Release Desktop

on:
  push:
    tags:
      - 'desktop-v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Install dependencies
        run: pnpm install

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/desktop-v}" >> $GITHUB_OUTPUT

      - name: Update version in tauri.conf.json
        run: |
          cd apps/desktop/src-tauri
          sed -i '' 's/"version": "[^"]*"/"version": "${{ steps.version.outputs.version }}"/' tauri.conf.json

      - name: Import Apple certificates
        if: ${{ env.APPLE_CERTIFICATE != '' }}
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          echo -n "$APPLE_CERTIFICATE" | base64 --decode > $CERTIFICATE_PATH

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

      - name: Build Tauri app (Universal)
        run: |
          cd apps/desktop
          pnpm tauri build --target universal-apple-darwin
        env:
          VITE_CONVEX_URL: ${{ secrets.VITE_CONVEX_URL }}
          VITE_CONVEX_SITE_URL: ${{ secrets.VITE_CONVEX_SITE_URL }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Hide .VolumeIcon.icns in DMG
        run: |
          DMG_PATH=$(find apps/desktop/src-tauri/target/universal-apple-darwin/release/bundle/dmg -name "*.dmg" | head -1)
          DMG_DIR=$(dirname "$DMG_PATH")
          DMG_NAME=$(basename "$DMG_PATH")
          TEMP_DMG="$DMG_DIR/temp_$DMG_NAME"
          VOLUME_NAME="Project Nebula"

          hdiutil convert "$DMG_PATH" -format UDRW -o "$TEMP_DMG"
          hdiutil attach "${TEMP_DMG}.dmg" -mountpoint "/Volumes/$VOLUME_NAME"

          osascript <<EOF
          tell application "Finder"
            tell disk "$VOLUME_NAME"
              open
              set current view of container window to icon view
              set theViewOptions to the icon view options of container window
              set icon size of theViewOptions to 100
              set the bounds of container window to {400, 100, 1060, 500}
              set position of item ".VolumeIcon.icns" to {1000, 1000}
              set position of item ".fseventsd" to {1100, 1000}
              close
              open
              delay 2
              close
            end tell
          end tell
          EOF

          sync
          hdiutil detach "/Volumes/$VOLUME_NAME"
          rm "$DMG_PATH"
          hdiutil convert "${TEMP_DMG}.dmg" -format UDZO -o "$DMG_PATH"
          rm "${TEMP_DMG}.dmg"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            apps/desktop/src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
            apps/desktop/src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app.tar.gz
            apps/desktop/src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app.tar.gz.sig

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install dependencies
        run: pnpm install

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/desktop-v}" >> $GITHUB_OUTPUT

      - name: Update version in tauri.conf.json
        run: |
          cd apps/desktop/src-tauri
          sed -i 's/"version": "[^"]*"/"version": "${{ steps.version.outputs.version }}"/' tauri.conf.json

      - name: Build Tauri app
        run: |
          cd apps/desktop
          pnpm tauri build
        env:
          VITE_CONVEX_URL: ${{ secrets.VITE_CONVEX_URL }}
          VITE_CONVEX_SITE_URL: ${{ secrets.VITE_CONVEX_SITE_URL }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage.tar.gz
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage.tar.gz.sig

  create-release:
    needs: [build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/desktop-v}" >> $GITHUB_OUTPUT

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-artifacts
          path: artifacts/macos

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-artifacts
          path: artifacts/linux

      - name: Generate latest.json manifest
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="calumpwebb/project-nebula"

          # Find the signature files
          MAC_SIG=$(cat artifacts/macos/*.app.tar.gz.sig 2>/dev/null || echo "")
          LINUX_SIG=$(cat artifacts/linux/*.AppImage.tar.gz.sig 2>/dev/null || echo "")

          cat > artifacts/latest.json << EOF
          {
            "version": "$VERSION",
            "notes": "Release $VERSION",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "darwin-aarch64": {
                "signature": "$MAC_SIG",
                "url": "https://github.com/$REPO/releases/download/desktop-v$VERSION/Project.Nebula_${VERSION}_aarch64.app.tar.gz"
              },
              "darwin-x86_64": {
                "signature": "$MAC_SIG",
                "url": "https://github.com/$REPO/releases/download/desktop-v$VERSION/Project.Nebula_${VERSION}_x64.app.tar.gz"
              },
              "linux-x86_64": {
                "signature": "$LINUX_SIG",
                "url": "https://github.com/$REPO/releases/download/desktop-v$VERSION/project-nebula_${VERSION}_amd64.AppImage.tar.gz"
              }
            }
          }
          EOF

          cat artifacts/latest.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Desktop v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/macos/**/*
            artifacts/linux/**/*
            artifacts/latest.json
