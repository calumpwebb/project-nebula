services:
  temporal:
    image: temporalio/auto-setup:1.25
    ports:
      - "7233:7233"   # gRPC
      - "8233:8233"   # Web UI
    environment:
      - DB=sqlite
      - SKIP_SCHEMA_SETUP=false
      - TEMPORAL_ADDRESS=temporal:7233
    volumes:
      - temporal-data:/var/lib/temporal
    healthcheck:
      test: ["CMD", "temporal", "operator", "cluster", "health"]
      interval: 5s
      timeout: 5s
      retries: 10

  worker:
    build:
      context: .
      dockerfile: apps/worker/Dockerfile
      target: development
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TASK_QUEUE=default
      - TEMPORAL_NAMESPACE=default
    volumes:
      # Hot reload: mount source code
      - ./apps/worker/src:/app/apps/worker/src:ro
      - ./packages/shared/src:/app/packages/shared/src:ro
    depends_on:
      temporal:
        condition: service_healthy
    restart: unless-stopped

  convex:
    image: convex/convex-local-backend:latest
    ports:
      - "3210:3210"   # Backend
      - "3211:3211"   # Dashboard
    volumes:
      - convex-data:/convex/data

volumes:
  temporal-data:
  convex-data:
