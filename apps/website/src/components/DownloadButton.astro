---
// Platform-aware download button with architecture dropdown
---

<div class="relative inline-block">
  <button
    id="download-btn"
    class="px-6 py-2 border border-gray-600 hover:border-gray-500 text-white transition-colors flex items-center gap-2"
  >
    <span id="download-text">[ loading... ]</span>
  </button>

  <div
    id="dropdown"
    class="hidden absolute top-full left-0 mt-1 w-full border border-gray-600 bg-background z-10"
  >
    <!-- Populated by JS -->
  </div>
</div>

<p id="fallback-link" class="hidden mt-4 text-muted-foreground">
  <a
    href="https://github.com/calumpwebb/nebula/releases/latest"
    class="hover:text-foreground transition-colors"
  >
    &gt; view all downloads
  </a>
</p>

<script>
  interface Release {
    tag_name: string
    assets: Array<{
      name: string
      browser_download_url: string
    }>
  }

  interface DownloadOption {
    label: string
    url: string
  }

  const GITHUB_REPO = 'calumpwebb/nebula'

  function detectPlatform(): 'macos' | 'linux' | 'windows' | 'unknown' {
    const ua = navigator.userAgent.toLowerCase()
    const platform = navigator.platform.toLowerCase()

    if (platform.includes('mac') || ua.includes('mac')) return 'macos'
    if (platform.includes('linux') || ua.includes('linux')) return 'linux'
    if (platform.includes('win') || ua.includes('win')) return 'windows'
    return 'unknown'
  }

  function getVersionFromTag(tag: string): string {
    return tag.replace('desktop-v', '')
  }

  function buildDownloadOptions(release: Release, platform: string): DownloadOption[] {
    const version = getVersionFromTag(release.tag_name)
    const options: DownloadOption[] = []

    if (platform === 'macos') {
      const arm64 = release.assets.find((a) => a.name === `Nebula_${version}_aarch64.dmg`)
      const x64 = release.assets.find((a) => a.name === `Nebula_${version}_x64.dmg`)

      if (arm64) {
        options.push({ label: 'Apple Silicon (M1/M2/M3)', url: arm64.browser_download_url })
      }
      if (x64) {
        options.push({ label: 'Intel', url: x64.browser_download_url })
      }
    } else if (platform === 'linux') {
      const appimage = release.assets.find((a) => a.name.endsWith('.AppImage'))
      if (appimage) {
        options.push({ label: 'Linux (x64)', url: appimage.browser_download_url })
      }
    }

    return options
  }

  async function init() {
    const btn = document.getElementById('download-btn')!
    const text = document.getElementById('download-text')!
    const dropdown = document.getElementById('dropdown')!
    const fallback = document.getElementById('fallback-link')!

    const platform = detectPlatform()

    if (platform === 'unknown' || platform === 'windows') {
      text.textContent = '[ view downloads ]'
      btn.addEventListener('click', () => {
        window.location.href = `https://github.com/${GITHUB_REPO}/releases/latest`
      })
      return
    }

    try {
      const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/releases/latest`)
      if (!response.ok) throw new Error('Failed to fetch release')

      const release: Release = await response.json()
      const options = buildDownloadOptions(release, platform)

      if (options.length === 0) {
        text.textContent = '[ view downloads ]'
        btn.addEventListener('click', () => {
          window.location.href = `https://github.com/${GITHUB_REPO}/releases/latest`
        })
        return
      }

      const platformLabel = platform === 'macos' ? 'macOS' : 'Linux'
      text.textContent = `[ Download for ${platformLabel} ]`

      if (options.length === 1) {
        btn.addEventListener('click', () => {
          window.location.href = options[0].url
        })
      } else {
        text.innerHTML = `[ Download for ${platformLabel} <span class="text-muted-foreground">â–¾</span> ]`

        dropdown.innerHTML = options
          .map(
            (opt) => `
          <a
            href="${opt.url}"
            class="block px-4 py-2 hover:bg-secondary text-sm transition-colors"
          >
            &gt; ${opt.label}
          </a>
        `
          )
          .join('')

        btn.addEventListener('click', (e) => {
          e.stopPropagation()
          dropdown.classList.toggle('hidden')
        })

        document.addEventListener('click', () => {
          dropdown.classList.add('hidden')
        })
      }

      fallback.classList.remove('hidden')
    } catch {
      text.textContent = '[ view downloads ]'
      btn.addEventListener('click', () => {
        window.location.href = `https://github.com/${GITHUB_REPO}/releases/latest`
      })
    }
  }

  init()
</script>
